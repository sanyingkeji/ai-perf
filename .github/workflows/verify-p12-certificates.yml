name: 验证 P12 证书

on:
  workflow_dispatch:
    inputs:
      test_application_p12:
        description: '测试 Application P12 证书'
        required: false
        type: boolean
        default: true
      test_installer_p12:
        description: '测试 Installer P12 证书'
        required: false
        type: boolean
        default: true

jobs:
  verify-certificates:
    runs-on: macos-latest
    
    steps:
      - name: 检查工作区
        run: |
          echo "工作目录: $(pwd)"
          echo "开始验证 P12 证书..."
      
      - name: 验证 Application P12 证书
        if: ${{ inputs.test_application_p12 != false }}
        env:
          APPLICATION_P12_BASE64: ${{ secrets.APPLICATION_P12_BASE64 }}
          APPLICATION_P12_PASSWORD: ${{ secrets.APPLICATION_P12_PASSWORD }}
        run: |
          echo "=========================================="
          echo "验证 Developer ID Application P12 证书"
          echo "=========================================="
          
          if [ -z "$APPLICATION_P12_BASE64" ]; then
            echo "⚠ 未设置 APPLICATION_P12_BASE64 secret，跳过 Application 证书验证"
            exit 0
          fi
          
          # 解码 p12 文件
          echo "$APPLICATION_P12_BASE64" | base64 --decode > /tmp/application.p12
          FILE_SIZE=$(stat -f%z /tmp/application.p12 2>/dev/null || echo "未知")
          echo "✓ P12 文件已解码（大小: $FILE_SIZE 字节）"
          
          # 验证文件是否为空
          if [ ! -s /tmp/application.p12 ]; then
            echo "✗ 文件为空或解码失败"
            exit 1
          fi
          
          # 尝试读取证书信息（使用 openssl 验证格式）
          echo ""
          echo "尝试读取证书信息..."
          if [ -n "$APPLICATION_P12_PASSWORD" ]; then
            CERT_INFO=$(openssl pkcs12 -in /tmp/application.p12 -passin pass:"$APPLICATION_P12_PASSWORD" -nokeys -clcerts 2>&1)
            OPENSSL_EXIT_CODE=$?
            if [ $OPENSSL_EXIT_CODE -eq 0 ]; then
              echo "✓ 文件格式正确（PKCS#12）"
              echo "✓ 密码正确，成功读取证书"
              
              # 提取证书主题和颁发者
              CERT_SUBJECT=$(echo "$CERT_INFO" | openssl x509 -noout -subject 2>/dev/null)
              CERT_ISSUER=$(echo "$CERT_INFO" | openssl x509 -noout -issuer 2>/dev/null)
              CERT_SERIAL=$(echo "$CERT_INFO" | openssl x509 -noout -serial 2>/dev/null)
              
              echo ""
              echo "证书信息："
              echo "  主题: $CERT_SUBJECT"
              echo "  颁发者: $CERT_ISSUER"
              echo "  序列号: $CERT_SERIAL"
              
              # 检查证书类型
              if echo "$CERT_SUBJECT" | grep -qi "Developer ID Application"; then
                echo "✓ 证书类型正确：Developer ID Application"
              else
                echo "⚠ 警告：证书类型可能不正确（期望：Developer ID Application）"
                echo "  实际证书主题包含: $CERT_SUBJECT"
              fi
              
              # 检查证书有效期
              CERT_NOT_BEFORE=$(echo "$CERT_INFO" | openssl x509 -noout -startdate 2>/dev/null | cut -d= -f2)
              CERT_NOT_AFTER=$(echo "$CERT_INFO" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              echo "  有效期从: $CERT_NOT_BEFORE"
              echo "  有效期至: $CERT_NOT_AFTER"
              
              # 检查是否过期
              CURRENT_DATE=$(date +%s)
              EXPIRY_DATE=$(date -j -f "%b %d %H:%M:%S %Y %Z" "$CERT_NOT_AFTER" +%s 2>/dev/null || echo "0")
              if [ "$EXPIRY_DATE" != "0" ] && [ "$CURRENT_DATE" -gt "$EXPIRY_DATE" ]; then
                echo "✗ 证书已过期！"
                exit 1
              else
                echo "✓ 证书未过期"
              fi
              
            else
              echo "✗ 无法读取证书"
              echo "错误信息: $CERT_INFO"
              echo ""
              echo "可能的原因："
              if echo "$CERT_INFO" | grep -qi "mac verify failure\|bad password"; then
                echo "  1. 密码错误"
              elif echo "$CERT_INFO" | grep -qi "invalid format\|bad magic number"; then
                echo "  1. 文件格式错误（不是有效的 PKCS#12 文件）"
                echo "  2. base64 解码可能有问题"
              else
                echo "  1. 文件格式错误或密码错误"
                echo "  2. 请检查 base64 编码是否正确"
              fi
              exit 1
            fi
          else
            echo "⚠ 未提供 APPLICATION_P12_PASSWORD，尝试无密码读取..."
            CERT_INFO=$(openssl pkcs12 -in /tmp/application.p12 -nokeys -clcerts 2>&1)
            if [ $? -eq 0 ]; then
              echo "✓ 文件格式正确（PKCS#12，无密码）"
            else
              echo "✗ 无法读取证书（可能需要密码或文件格式错误）"
              echo "错误信息: $CERT_INFO"
              exit 1
            fi
          fi
          
          # 创建临时 keychain 测试导入
          echo ""
          echo "测试导入到临时 keychain..."
          TEST_KEYCHAIN="test_application_$(date +%s).keychain"
          TEST_KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$TEST_KEYCHAIN_PASSWORD" "$TEST_KEYCHAIN"
          security set-keychain-settings -lut 21600 "$TEST_KEYCHAIN"
          security unlock-keychain -p "$TEST_KEYCHAIN_PASSWORD" "$TEST_KEYCHAIN"
          
          KEYCHAIN_PATH="$HOME/Library/Keychains/${TEST_KEYCHAIN}-db"
          if [ ! -f "$KEYCHAIN_PATH" ]; then
            KEYCHAIN_PATH="$HOME/Library/Keychains/${TEST_KEYCHAIN}"
          fi
          
          if [ -n "$APPLICATION_P12_PASSWORD" ]; then
            IMPORT_RESULT=$(security import /tmp/application.p12 -k "$KEYCHAIN_PATH" -P "$APPLICATION_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security 2>&1)
            IMPORT_EXIT_CODE=$?
          else
            IMPORT_RESULT=$(security import /tmp/application.p12 -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security 2>&1)
            IMPORT_EXIT_CODE=$?
          fi
          
          if [ $IMPORT_EXIT_CODE -eq 0 ]; then
            echo "✓ 证书导入成功"
            
            # 列出导入的证书
            echo ""
            echo "Keychain 中的证书："
            security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            
            # 清理
            security delete-keychain "$TEST_KEYCHAIN" 2>/dev/null || true
          else
            echo "✗ 证书导入失败（退出码: $IMPORT_EXIT_CODE）"
            echo "错误信息: $IMPORT_RESULT"
            security delete-keychain "$TEST_KEYCHAIN" 2>/dev/null || true
            exit 1
          fi
          
          rm -f /tmp/application.p12
          echo ""
          echo "✓ Application P12 证书验证完成"
      
      - name: 验证 Installer P12 证书
        if: ${{ inputs.test_installer_p12 != false }}
        env:
          INSTALLER_P12_BASE64: ${{ secrets.INSTALLER_P12_BASE64 }}
          INSTALLER_P12_PASSWORD: ${{ secrets.INSTALLER_P12_PASSWORD }}
        run: |
          echo "=========================================="
          echo "验证 Developer ID Installer P12 证书"
          echo "=========================================="
          
          if [ -z "$INSTALLER_P12_BASE64" ]; then
            echo "⚠ 未设置 INSTALLER_P12_BASE64 secret，跳过 Installer 证书验证"
            exit 0
          fi
          
          # 解码 p12 文件
          echo "$INSTALLER_P12_BASE64" | base64 --decode > /tmp/installer.p12
          FILE_SIZE=$(stat -f%z /tmp/installer.p12 2>/dev/null || echo "未知")
          echo "✓ P12 文件已解码（大小: $FILE_SIZE 字节）"
          
          # 验证文件是否为空
          if [ ! -s /tmp/installer.p12 ]; then
            echo "✗ 文件为空或解码失败"
            exit 1
          fi
          
          # 尝试读取证书信息（使用 openssl 验证格式）
          echo ""
          echo "尝试读取证书信息..."
          if [ -n "$INSTALLER_P12_PASSWORD" ]; then
            CERT_INFO=$(openssl pkcs12 -in /tmp/installer.p12 -passin pass:"$INSTALLER_P12_PASSWORD" -nokeys -clcerts 2>&1)
            OPENSSL_EXIT_CODE=$?
            if [ $OPENSSL_EXIT_CODE -eq 0 ]; then
              echo "✓ 文件格式正确（PKCS#12）"
              echo "✓ 密码正确，成功读取证书"
              
              # 提取证书主题和颁发者
              CERT_SUBJECT=$(echo "$CERT_INFO" | openssl x509 -noout -subject 2>/dev/null)
              CERT_ISSUER=$(echo "$CERT_INFO" | openssl x509 -noout -issuer 2>/dev/null)
              CERT_SERIAL=$(echo "$CERT_INFO" | openssl x509 -noout -serial 2>/dev/null)
              
              echo ""
              echo "证书信息："
              echo "  主题: $CERT_SUBJECT"
              echo "  颁发者: $CERT_ISSUER"
              echo "  序列号: $CERT_SERIAL"
              
              # 检查证书类型
              if echo "$CERT_SUBJECT" | grep -qi "Developer ID Installer"; then
                echo "✓ 证书类型正确：Developer ID Installer"
              else
                echo "✗ 错误：证书类型不正确！"
                echo "  期望：Developer ID Installer"
                echo "  实际证书主题: $CERT_SUBJECT"
                echo ""
                echo "  可能的原因："
                echo "    1. 这是 Application 证书，不是 Installer 证书"
                echo "    2. 证书文件错误"
                exit 1
              fi
              
              # 检查证书有效期
              CERT_NOT_BEFORE=$(echo "$CERT_INFO" | openssl x509 -noout -startdate 2>/dev/null | cut -d= -f2)
              CERT_NOT_AFTER=$(echo "$CERT_INFO" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
              echo "  有效期从: $CERT_NOT_BEFORE"
              echo "  有效期至: $CERT_NOT_AFTER"
              
              # 检查是否过期
              CURRENT_DATE=$(date +%s)
              EXPIRY_DATE=$(date -j -f "%b %d %H:%M:%S %Y %Z" "$CERT_NOT_AFTER" +%s 2>/dev/null || echo "0")
              if [ "$EXPIRY_DATE" != "0" ] && [ "$CURRENT_DATE" -gt "$EXPIRY_DATE" ]; then
                echo "✗ 证书已过期！"
                exit 1
              else
                echo "✓ 证书未过期"
              fi
              
            else
              echo "✗ 无法读取证书"
              echo "错误信息: $CERT_INFO"
              echo ""
              echo "可能的原因："
              if echo "$CERT_INFO" | grep -qi "mac verify failure\|bad password"; then
                echo "  1. 密码错误"
              elif echo "$CERT_INFO" | grep -qi "invalid format\|bad magic number"; then
                echo "  1. 文件格式错误（不是有效的 PKCS#12 文件）"
                echo "  2. base64 解码可能有问题"
              else
                echo "  1. 文件格式错误或密码错误"
                echo "  2. 请检查 base64 编码是否正确"
              fi
              exit 1
            fi
          else
            echo "⚠ 未提供 INSTALLER_P12_PASSWORD，尝试无密码读取..."
            CERT_INFO=$(openssl pkcs12 -in /tmp/installer.p12 -nokeys -clcerts 2>&1)
            if [ $? -eq 0 ]; then
              echo "✓ 文件格式正确（PKCS#12，无密码）"
            else
              echo "✗ 无法读取证书（可能需要密码或文件格式错误）"
              echo "错误信息: $CERT_INFO"
              exit 1
            fi
          fi
          
          # 创建临时 keychain 测试导入
          echo ""
          echo "测试导入到临时 keychain..."
          TEST_KEYCHAIN="test_installer_$(date +%s).keychain"
          TEST_KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$TEST_KEYCHAIN_PASSWORD" "$TEST_KEYCHAIN"
          security set-keychain-settings -lut 21600 "$TEST_KEYCHAIN"
          security unlock-keychain -p "$TEST_KEYCHAIN_PASSWORD" "$TEST_KEYCHAIN"
          
          KEYCHAIN_PATH="$HOME/Library/Keychains/${TEST_KEYCHAIN}-db"
          if [ ! -f "$KEYCHAIN_PATH" ]; then
            KEYCHAIN_PATH="$HOME/Library/Keychains/${TEST_KEYCHAIN}"
          fi
          
          if [ -n "$INSTALLER_P12_PASSWORD" ]; then
            IMPORT_RESULT=$(security import /tmp/installer.p12 -k "$KEYCHAIN_PATH" -P "$INSTALLER_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/productsign 2>&1)
            IMPORT_EXIT_CODE=$?
          else
            IMPORT_RESULT=$(security import /tmp/installer.p12 -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/productsign 2>&1)
            IMPORT_EXIT_CODE=$?
          fi
          
          if [ $IMPORT_EXIT_CODE -eq 0 ]; then
            echo "✓ 证书导入成功"
            
            # 设置 keychain 访问权限（必须在查找证书之前设置）
            echo "设置 keychain 访问权限..."
            security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k "$TEST_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" || true
            
            # 将 keychain 添加到搜索列表
            echo "将 keychain 添加到搜索列表..."
            security list-keychains -d user -s "$KEYCHAIN_PATH" || true
            
            # 等待一下，确保证书被索引
            sleep 1
            
            # 列出导入的证书（先列出所有证书，包括不可用的）
            echo ""
            echo "Keychain 中的所有证书："
            security find-identity -v "$KEYCHAIN_PATH" || true
            
            echo ""
            echo "Keychain 中可用于代码签名的证书："
            security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            
            # 验证 productsign 可以找到证书
            echo ""
            echo "验证 productsign 可以访问证书..."
            INSTALLER_IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" 2>/dev/null | grep "Developer ID Installer" | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
            if [ -n "$INSTALLER_IDENTITY" ]; then
              echo "✓ 找到 Installer 证书: $INSTALLER_IDENTITY"
              echo "✓ productsign 可以访问证书"
            else
              echo "⚠ 未在代码签名证书列表中找到 Developer ID Installer 证书"
              echo "尝试在所有证书中查找..."
              ALL_CERTS=$(security find-identity -v "$KEYCHAIN_PATH" 2>/dev/null)
              if echo "$ALL_CERTS" | grep -q "Developer ID Installer"; then
                echo "✓ 证书存在于 keychain 中，但可能未标记为可用于代码签名"
                echo "证书列表："
                echo "$ALL_CERTS" | grep "Developer ID Installer"
                echo ""
                echo "这可能是因为证书需要信任设置，但在 CI 环境中这通常不是问题"
                echo "实际使用时，productsign 应该能够访问证书"
              else
                echo "✗ 完全未找到 Developer ID Installer 证书"
                echo "所有证书："
                echo "$ALL_CERTS"
                security delete-keychain "$TEST_KEYCHAIN" 2>/dev/null || true
                exit 1
              fi
            fi
            
            # 清理
            security delete-keychain "$TEST_KEYCHAIN" 2>/dev/null || true
          else
            echo "✗ 证书导入失败（退出码: $IMPORT_EXIT_CODE）"
            echo "错误信息: $IMPORT_RESULT"
            security delete-keychain "$TEST_KEYCHAIN" 2>/dev/null || true
            exit 1
          fi
          
          rm -f /tmp/installer.p12
          echo ""
          echo "✓ Installer P12 证书验证完成"
      
      - name: 验证总结
        run: |
          echo "=========================================="
          echo "验证总结"
          echo "=========================================="
          echo "✓ 所有证书验证完成"
          echo ""
          echo "如果看到此消息，说明："
          echo "  1. P12 文件格式正确"
          echo "  2. 密码正确（如果提供了密码）"
          echo "  3. 证书类型正确（Application/Installer）"
          echo "  4. 证书未过期"
          echo "  5. 证书可以成功导入到 keychain"
          echo "  6. productsign 可以访问 Installer 证书（如果测试了）"
          echo ""
          echo "如果验证失败，请检查："
          echo "  1. P12 文件是否正确（base64 编码）"
          echo "  2. 密码是否正确"
          echo "  3. 证书类型是否匹配（Application vs Installer）"
          echo "  4. 证书是否过期"
